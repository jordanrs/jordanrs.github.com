
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Jordan Rogers-Smith</title>
	<meta name="author" content="Jordan Rogers-Smith">

	
	<meta name="description" content="Jun 18th, 2013 Learning Chef From Scratch - Building a EC2 Backed Rails Stack Part 2 Setting up our Cookbooks and Recipes To manage our cookbooks &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Jordan Rogers-Smith" type="application/atom+xml">
	
	<link rel="canonical" href="http://jordanrs.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("jordanrs2k1@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
</div>
<hgroup>
  <h1><a href="/">Jordan Rogers-Smith</a></h1>
  
    <h2>Coding away day to day.</h2>
  
</hgroup>


<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/JRogersSmith" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/jordanrs" title="GitHub">GitHub</a>
		
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/jordanrogerssmith">LinkedIn</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-18T08:29:00+01:00" data-updated="true" itemprop="datePublished">Jun 18<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/06/18/learning-chef-from-scratch-building-a-ec2-backed-rails-stack-part-2/" itemprop="url">Learning Chef From Scratch - Building a EC2 Backed Rails Stack Part 2</a></h1>
	<h2 class="sub_heading" itemprop="name">Setting up our Cookbooks and Recipes</h2>
	<div class="entry-content" itemprop="articleBody">
		<p>To manage our cookbooks and first gem install berkshelf <a href="berkshelf">!! LINK BERKSHELF!!</a> this is to cookbooks what bundler is to gems. So do <code>gem install bershelf</code> then run berks init in our chef-repo route to create a Berkshelf file. Once you know what software you wish to install, find the relevant cookbooks on <a href="">OPSCODE SITE LINK</a> and add the them to your Berks file. Berkshelf docs are very through in what you can do with it so its worth reading.</p>

<p>Once you have the cook books you want in your Berksfile run <code>berks install</code> to install them. Like gems they are stored away from the project so dont eb surpriesd that our cookboks fodler is still empty.</p>

<p>and finally do <code>berks upload</code> to have our cookbooks uploaded to our chef server so they are available to any of the clients later on.</p>

<h1>Setting up a role</h1>

<h1>Creating our first Cookbook</h1>

<h1>Writing a recipe</h1>

<h1>Turning our instance into its role</h1>

<p>The most important thing i think to understand about chef is that it is IDEPOATENST. That is, if a command has been run once and was successfull, it should not be run again. Its worth bearing this in mind while writing recipies and why its useful to get familiar with Chefs or another Cookbooks DSL</p>

<p>rake install &ndash; updates the cookbooks and roles</p>

<p>knife ssh name:i-2853dd65 -x ubuntu &ldquo;sudo chef-client&rdquo; this tells our chef client (the server we are configuring) to update its self from the server</p>

<p><a href="http://docs.opscode.com/chef_client.html">http://docs.opscode.com/chef_client.html</a> how to set chef-client up to run as a deamon that by default gets called every</p>

<p>So some cook books wont have a recipe, so how do we get to use them in cookbook</p>

<p>like applciation and application_ruby both have no recipes so we create a new cook book and recipe that dpends on these cook books</p>

<pre><code>depends "application"
depends "application_ruby"
</code></pre>

<p>INCLUDE FILES FROM REPO AND HEAVILY COMMENT THEM</p>

<p>when create a server with knife we define it a role such as webserver, we than create a role and define a run list which is the order things will be installed in by chef</p>

<pre><code>name "webserver"
description "basic example"
run_list(
  "recipe[apt]",
  "recipe[build-essential]",
  "recipe[nginx]",
  "recipe[ruby_build]",
  "recipe[example]"
)
</code></pre>

<p>we can also override the default attributes of any of these cook books</p>

<p>at the bottom we have our</p>

<p>since we didnt spcify a role when the server was created we can chage this by doing knife node list &ndash; get the identifier and then knife node edit <identifer>  at the bottom</p>

<p>&ldquo;run_list&rdquo;: [
  &ldquo;role[webserver]&rdquo;
]</p>

<p>now when ever we run sudo chef-client configures this as the webserver role</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-01T10:27:00+01:00" data-updated="true" itemprop="datePublished">Jun 1<span>st</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/06/01/testing-facebook-login-and-permissions-with-capybara/" itemprop="url">Testing Facebook Login and Permissions With Capybara</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>Having begun to use Capybara and Rspec quiet heavily there have been a few challenges that need to be overcome. One of these is that the applications I develop day to day are heavily intertwined with Facebook and user flow relies heavily on Facebook login and accepting permissions at various points throughout the application.</p>

<p>Outside of the Facebook chrome (the non iframed version of the application) its quite easy interact with these events as if we were a normal user.</p>

<p><strong>Use Facebook Test Users</strong></p>

<p>First go to your Facebook applications roles dashboard at <a href="https://developers.facebook.com/apps/">https://developers.facebook.com/apps/</a>[APPID]/roles and create some test users and if needed make them friends with one another. Take a note of there email, fbid and create a password for them.</p>

<p><strong>Capybara Settings</strong></p>

<p>Since Facebook is an external service we need to extend Capybaras default wait time incase its being slow and also change the host that the specs run under so that it matches the settings for our Facebook app.</p>

<pre><code>Capybara.default\_wait\_time = 10
Capybara.app_host = 'http://' + Settings.host
</code></pre>

<p><strong>Test User Factory</strong></p>

<p>The FactoryGirl gem provides a great way to create and manage test data based on rails models. FactoryGirl can even be used with things other than models so to keep my actual user model separate from my test users data I created a special TestUser class. By placing it in a subfolder of the support folder the default installation will load all files and sub folders at initialisations allowing us access to this special class in our tests.</p>

<pre><code># spec/support/models/test_user.rb
class TestUser
   attr_accessor  :email, :password, :fbid, :name
end
</code></pre>

<p>With this class its then easily to make a test_user factory as you would a rails model factory. In this instance iv used a nested factory for additional test users with different states.</p>

<p> FactoryGirl.define do
   factory :test_user do |f|</p>

<pre><code> name 'Bob Ameibdcaahgd Liangman'
 fbid '100005892102238'
 email 'oyncoeh_liangman_1368123301@tfbnw.net'
 password 'XXXX'

 factory :test_user_mark do
   name 'Mark Ameiehbaakf Wisemanstein'
   fbid '100005958231006'
   email 'dqfaoxm_wisemanstein_13684123@tfbnw.net'
   password 'XXXX'
 end

 factory :test_user_arabic do
   name 'Richard Amehgghdihei Changescu'
   fbid '100005877823859'
   email 'lifczou_changescu_1368123920@tfbnw.net'
   password 'XXXX'
 end
</code></pre>

<p>   end
 end</p>

<p>Using these tests users in a capybara spec only has one caveat. They must be created in memory using build since there isn&rsquo;t a database table for them to be saved to</p>

<pre><code>let(:test_user_mark) do
  FactoryGirl.build(:test_user_mark)
end
</code></pre>

<p><strong>Automating Facebook</strong></p>

<p>The following module is a collection of macros that take care of the Facebook login and permissions dialogues. It attempts to deal with the various possible flows that can happen when using login with Facebook depending on wether the user has logging in and is being asked for permissions in the same sequence or if the permission are taken at a different point. There is also some javascript macros for login the user out of Facebook and removing the app permissions</p>

<pre><code># spec/support/facebook_macros
module FacebookMacros

  def complete_facebook_dialogues_on_click(selector, test_user)
    # until bookface version bumped to latest we have no way to know its ready so delay, not ideal
    sleep 1
    find("#{selector}").click
    return if page.driver.browser.window_handles.length == 1
    within_window('Facebook') do
      fill_in_facebook_form(test_user) if page.has_css?('#loginbutton')
      accept_permissions_outside_facebook
    end
  end

  def fill_in_facebook_form(test_user)
    fill_in('email', :with =&gt; "#{test_user.email}") 
    fill_in('pass', :with =&gt; "#{test_user.password}")
    find('#loginbutton').click
  end

  def accept_additional_permissions
    return if page.driver.browser.window_handles.length == 1
    within_window('Facebook') do
      accept_permissions_outside_facebook
    end
  end

  def accept_permissions_outside_facebook
    find(:xpath, "//button[@name='__CONFIRM__']").click if page.driver.browser.window_handles.length == 2
    find(:xpath, "//button[@name='__CONFIRM__']").click if page.driver.browser.window_handles.length == 2
  end

  def deauth_app
    sleep 1
    page.execute_script %Q{
       FB.api("/me/permissions","DELETE", function(response){
         console.log(response)
       });
     }
    sleep 1
  end

  def logout
    sleep 1
    page.execute_script %Q{
      FB.logout(function(response) {
        // user is now logged out
      });
     }
    sleep 1
  end

end
</code></pre>

<p>The above module can be easily included in Rspec&rsquo;s configure block with the config.includes command</p>

<pre><code>RSpec.configure do |config|

  ....
  config.include FacebookMacros
  ....

end
</code></pre>

<p>An example scenario using these macros. Its important that they are run with javascript enabled.</p>

<pre><code>scenario 'user import friends', :js =&gt; true do
  visit root_path  
  complete_facebook_dialogues_on_click('#auth_me', test_user)
  page.should have_css('#entry_step_1') 
  visit home_dashboard_path


  expect{

    sleep 2
    find('#add_events').click

    accept_additional_permissions
    sleep 2

    page.should_not have_css('#add_events')
    page.should have_css('.events_item')
    # deal with additional perms
  }.to change(Event, :count)


  logout
  Capybara.reset_session!
end
</code></pre>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-26T00:00:00+01:00" data-updated="true" itemprop="datePublished">May 26<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/05/26/Learning-Chef-From-Scratch---Building-a-EC2-backed-Rails-Stack-Part-1/" itemprop="url">Learning Chef From Scratch - Building a EC2 Backed Rails Stack Part 1</a></h1>
	<h2 class="sub_heading" itemprop="name">Setup Chef and Creating a EC2 instance</h2>
	<div class="entry-content" itemprop="articleBody">
		<p>Chef is a fantastic tool for automating the process bootstrapping a fresh server so that once you have got it running how you want, replicating that configuration and setup requires very little effort what so ever.</p>

<p>Chef has two different use cases, Chef server (wether that be hosted or private) or Chef Solo. Chef solo allows you to interact directly with the machine your wanting to administrate and is very useful for bootstrapping a vagrant image for instance. Chef Server offers a centralised place for you to push your configurations and recipes so that when working with multiple servers (known as nodes or chef clients) you don&rsquo;t have to update each one individually as each client can be set to poll to server for any updates.</p>

<p>For my first time using chef i through myself straight in at the deep end in that i wanted to put together a full working EC2 instance that would run my usual heroku stack (nginx, unicorn, ruby, rails and postgres). I opted for using Opscodes free Chef hosted plan for my Chef server and got straight to it.</p>

<h1>Getting Set Up</h1>

<p>First of head over to <a href="http://www.opscode.com">www.opscode.com</a> and sign up for a free account. There will be three files to download. Your user key, your organisation key and your preconfigured knife.rb file. Download these files and keep them safe for now, we will use them in just a second.</p>

<p>Next we need to get our bootstrapped Chef Repository, this is our blank slate to begin building up our server and its configuration. Grab a empty <a href="http://github.com/opscode/chef-repo/">Chef Repo</a> from opscodes git hub and clone it to where ever you desire.</p>

<pre><code>git clone git@github.com:opscode/chef-repo.git
</code></pre>

<p>Next we need to move our .pem and knife.rb files into a .chef folder in this repository. You will most likely have to make the .chef folder.</p>

<p><img src="/images/post_images/23-05-26-chef/folder_layout.png" alt="Folder Layout" /></p>

<h1>Gem Time</h1>

<p>Now we have our directory structure in place we should install the gems we need to make the magic happen. A complete guide to setting up chef can be found here <a href="LINK%20TO%20CHEG"></a> as i wont go into the details of installing ruby, rvm, bundler etc to enable the installation of gems.</p>

<p>The main gems needed are the chef and knife-ec2 gems</p>

<p><a href="http://github.com/opscode/chef-repo/tarball/master">http://github.com/opscode/chef-repo/tarball/master</a></p>

<p>and in a .chef folder which has your shared keys, your user keys and your organisation validator key and your knife.rb</p>

<p>Hosted chef server</p>

<p><a href="http://www.agileweboperations.com/amazon-ec2-instances-with-opscode-chef-using-knife">http://www.agileweboperations.com/amazon-ec2-instances-with-opscode-chef-using-knife</a></p>

<p><a href="http://wiki.opscode.com/display/chef/EC2+Bootstrap+Fast+Start+Guide">http://wiki.opscode.com/display/chef/EC2+Bootstrap+Fast+Start+Guide</a></p>

<h1>Creating a EC2 instance with knife</h1>

<p>A few prerequisites are needed before we can create instances with knife. First you will need a AWS account which is free and comes with a <a href="http://aws.amazon.com/free/">free usage tier for the first year</a>. Once setup you will need to include your amazon API key and secret into your knife.rb file</p>

<pre><code>knife[:aws_access_key_id] = "AAAAAAAAAAAAAAAAAAA"
knife[:aws_secret_access_key] = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
</code></pre>

<p>Next set up your default security policy or an alternative one which we can specify when creating the instance, to allow access to port 22, 80 and 443. This is so HTTP, HTTPS and SSH can all be accessed on the created instance.</p>

<p>In the same dashboard go to key pairs panel and create a new security key. The file will automatically download and should be moved into your ~/.ssh folder and the permissions changed to 600 (chmod 600 ~/.ssh/AWS-KEY.pem)</p>

<p>Finally decided what operating system, location, storage and instance size you want. All of these factor into which AMI will be installed on our instance. For instance <a href="http://cloud-images.ubuntu.com/locator/ec2/">this site</a> put together by ubuntu gives you a list of all the different AMIs for the numerous combination of these factors with ubuntu as your base OS.</p>

<p>In my case i went for ami-7962730d which is a eu-west 32bit version of Ubuntu 12.04 for a micro instance.</p>

<p>We are now ready to create our instance using knife, the command to do that is quite large but I shall show you a few things you can move into the knife folder as defaults to make it more manageable</p>

<pre><code># run this command to begin boot strapping our server.

knife ec2 server create -I ami-7962730d -f t1.micro -S knife -i ~/.ssh/AWS-KEY.pem --ssh-user ubuntu --region eu-west-1 -Z eu-west-1a
</code></pre>

<p>If you chose a different security group other than the default you can specify it here with the -G &lsquo;group&rsquo; argument and the &mdash;ssh-user argument is ubuntu as that is the default user that comes with the AMI and is needed for us to be able to ssh in with.</p>

<p>All that happens now is a new instance is created and the OS is installed once complete chef automatically SSHs in to the new machine and install chef-client on the server, registers it on on chef server and checks to see if we have specified any roles or recipes, in this instance we haven&rsquo;t.</p>

<h2>Shortening the creation command</h2>

<p>Add the <strong>AWS-KEY.pem</strong> to your ssh agent means you can remove the <code>-i ~/.ssh/AWS-KEY.pem</code> from the command</p>

<pre><code>ssh-add ~/.ssh/AWS-KEY.pem

# Command now becomes
knife ec2 server create -I ami-7962730d -f t1.micro -S knife --ssh-user ubuntu --region eu-west-1 -Z eu-west-1a
</code></pre>

<p>Add <code>knife[:aws_ssh_key_id] = "AWS-KEY"</code> to knife.rb and we can remove -S knife</p>

<pre><code>knife ec2 server create -I ami-7962730d -f t1.micro --ssh-user ubuntu --region eu-west-1 -Z eu-west-1a
</code></pre>

<p>And finally add availability_zone and region to knife.rb</p>

<pre><code>knife[:availability_zone]     = 'eu-west-1a'
knife[:region]                = 'eu-west-1'
</code></pre>

<p>to produce the final command</p>

<pre><code>knife ec2 server create -I ami-7962730d -f t1.micro --ssh-user ubuntu
</code></pre>

<p>After all its installation is done you should see a read out like so, make a note of the <strong>Instance ID</strong> as this is what chef uses to identify this node.</p>

<pre><code>Instance ID: i-XXXXXXXX
Flavor: t1.micro
Image: ami-7962730d
Region: eu-west-1
Availability Zone: eu-west-1a
Security Groups: default
Tags: {"Name"=&gt;"i-XXXXXXXX"}
SSH Key: chef-test

Waiting for instance..............................................
Public DNS Name: ecX-XX-XXX-XXX-X.eu-west-1.compute.amazonaws.com
Public IP Address: XX.XXX.XXX.X
Private DNS Name: ip-XX-XX-XXX-XXX.eu-west-1.compute.internal
Private IP Address: XX.XX.XXX.XXX

Waiting for sshd....done
Bootstrapping Chef on ec2-XX-XXX-XXX-X.eu-west-1.compute.amazonaws.com
</code></pre>

<p>So now we have a node/client associated with our chef server we can begin building up our cookbooks to install our stack which i shall cover in <a href="/blog/2013/06/18/learning-chef-from-scratch-building-a-ec2-backed-rails-stack-part-2/">Part 2</a>.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-25T00:00:00+01:00" data-updated="true" itemprop="datePublished">Apr 25<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/25/installing-guard-and-spork-for-auto-running-of-tests/" itemprop="url">Installing Guard and Spork for Auto Running of Specs&#8217;</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<h2>Gemfile</h2>

<p>Install the following gems with <code>bundle install</code></p>

<pre><code>group :test_envs do
  gem 'rspec-rails', "~&gt; 2.0"
  gem 'factory_girl_rails'
  gem 'faker'
  gem 'capybara', "~&gt; 2.0.2"
  gem 'database_cleaner', "~&gt; 0.9.1"
  gem 'launchy'

  # file system event triggers for ruby. See note at end about RVM 
  gem 'rb-fsevent', '0.9.3'

  # Notifications of test states, Requires Growl and growlnotify to be installed
  gem 'growl', '1.0.3'

  # Automated test running and speed imporvements
  gem 'guard-rspec'
  gem 'guard-spork', '1.2.0'
  gem 'childprocess', '0.3.6'# this was due to errors appearing in 0.3.7 and higher
  gem 'spork', '0.9.2'
  gem 'debugger'
end
</code></pre>

<h2>spec/spec_helper</h2>


		
		<a href="/blog/2013/04/25/installing-guard-and-spork-for-auto-running-of-tests/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-23T00:00:00+01:00" data-updated="true" itemprop="datePublished">Apr 23<span>rd</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/23/multiple-test-enviroments/" itemprop="url">Multiple Test Environments in Rails</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>Create the file <code>config/enviroments/jordan_test.rd</code> and copy into it the contents of <code>config/enviroments/test.rb</code>
Via command line from application root:  <code>cp config/environments/test.rb config/environments/jordan_test.rb</code></p>

<p>in config/database.yml add your DB settings (assumes using Postgres)</p>

<pre><code>jordan_test:
  adapter: postgresql
  encoding: utf8
  host: localhost
  database: [project_name]_jordan_test
  username: 
  password: 
</code></pre>

<p>Create the new database</p>

<pre><code>rake db:create:all
</code></pre>

<p>add environment to any :test specific gems or gem groups in your gem file</p>

<pre><code>group :test, :jordan_test do
    #blaaaaa........
end
</code></pre>

<p>or make a bundler group in application.rb so others envs can be added easier.</p>

<pre><code>if defined?(Bundler)
  # If you precompile assets before deploying to production, use this line
  Bundler.require(*Rails.groups(:assets =&gt; %w(development test steve cronin sexyjordan_test), :test_envs =&gt; %w(test sexyjordan_test)))
  # If you want your assets lazily compiled in production, use this line
  # Bundler.require(:default, :assets, Rails.env)
end   
</code></pre>

<p>Usual run rake <code>db:test:prepare</code> or <code>db:test:clone</code> instead possible to run <code>rake db:migrate RAILS_ENV=jordan_test</code> perhaps make an alias for this in your .bash_profile</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-05T00:00:00+01:00" data-updated="true" itemprop="datePublished">Apr 5<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/05/strong-parameters-and-tolk-gem/" itemprop="url">Strong Parameters and Tolk Gem</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>To get the tolk gem to work along side the Strong Parameters gem we need to apply a monkey patch to tolk</p>

<pre><code>in config/initalizers/tolk.rb

Tolk::LocalesController.class_eval do  
    def create
      Tolk::Locale.create!(params[:tolk_locale].try(:permit!))
      redirect_to :action =&gt; :index
    end
end
</code></pre>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-02-21T00:00:00+00:00" data-updated="true" itemprop="datePublished">Feb 21<span>st</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/21/making-a-gem/" itemprop="url">Making a Gem</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>As to not forget the process of packaging up a gem and putting it on my own hosting just follow these simple tests :&ndash;</p>

<p>1) Firstly make sure the <code>PROJECT_NAME.gemspec</code> file is up to date and you have updated the <code>version.rb</code> file to the correct version.</p>

<p>2) run the command <code>gem build mention-tagger.gemspec</code> or <code>rake build</code>
that should put a gem file in the root directory with the name <code>PROJECT_NAME-VERSION.gem</code> or in <code>pkg/PROJECT_NAME-VERSION.gem</code></p>

<p>To publish to your own gem host</p>

<p>1) First set up geminabox as per these <a href="https://github.com/cwninja/geminabox">instructions</a></p>

<ul>
<li>gem install geminabox</li>
</ul>


<p>2) then gem inabox <code>PROJECT_NAME-VERSION.gem</code></p>

<p>it&rsquo;ll ask for url</p>

<p>3) put in your gem host</p>

<p>and away she goes</p>

<h2>Get it straight from git</h2>

<p>Two ways</p>

<ol>
<li>gem &lsquo;rails&rsquo;, :git => &lsquo;git://github.com/rails/rails.git&rsquo;</li>
</ol>


<p>or equivalently</p>

<ol>
<li>gem &lsquo;rails&rsquo;, :githib => &lsquo;rails/rails&rsquo;</li>
</ol>


<p>which is just <em>USERNAME/PROJECT_NAME</em></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-02-12T00:00:00+00:00" data-updated="true" itemprop="datePublished">Feb 12<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/reminders/'>reminders</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/12/activeadmin---customising-export-links/" itemprop="url">ActiveAdmin - Customising Export Links</a></h1>
	<h2 class="sub_heading" itemprop="name">Removing JSON/XML</h2>
	<div class="entry-content" itemprop="articleBody">
		<p>When using active admin there doesn&rsquo;t seem to be an easy way to format the output of the JSON and XML export options like you can with the CSV option.</p>

<p>A nice patch by <a href="https://coderwall.com/p/qzlssg">David Collom</a> allows us to customise what is displayed rather then just hiding it in CSS. The patch is as follows and i just placed it at the top of one of my <code>admin/###.rb</code> files</p>

<pre><code>module ActiveAdmin
  module Views
    class PaginatedCollection
      def build_pagination_with_formats(options)
        div :id =&gt; "index_footer" do
          build_pagination
          div(page_entries_info(options).html_safe, :class =&gt; "pagination_information")
          build_download_format_links([:csv]) unless @download_links == false
        end
      end
    end
  end
end
</code></pre>

<p>To customise what is displayed simplay change the array passing into <code>build_download_format_links()</code></p>

<pre><code>build_download_format_links([:csv]) 
build_download_format_links([:csv, :json])
</code></pre>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-02-10T00:00:00+00:00" data-updated="true" itemprop="datePublished">Feb 10<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/reminders/'>reminders</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/10/s3-static-assets-group-policy/" itemprop="url">S3 Static Assets Group Policy</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>I always struggle to remember / find the group security policy for an S3 bucket to make all files available to the public.</p>

<pre><code>{
    "Version": "2008-10-17",
    "Statement": [
        {
            "Sid": "AllowPublicRead",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::BUCKET-NAME/*"
        }
    ]
}
</code></pre>

<p>The only thing that can be changed is the BUCKET-NAME, leave all other aspects of the policy the same.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-02-10T00:00:00+00:00" data-updated="true" itemprop="datePublished">Feb 10<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories//'></a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/02/10/heroku-optimisations---unicorn-s3-and-cloudfront/" itemprop="url">Heroku Optimisations - Unicorn, S3 and Cloudfront</a></h1>
	<h2 class="sub_heading" itemprop="name"></h2>
	<div class="entry-content" itemprop="articleBody">
		<p>As part of my continued learnings as a rails developer I had some free time during the week and looked into optimising heroku to make my rails apps far more efficient and effective. When i tested unicorn it showed itself to be a awesomely efficient application server giving you far more bang for your buck on heroku. Heres a quick guide of how I set up unicorn and some additional optimisations using s3 and cloudfront to serve my files that will now become my default set up to get the most out of my dynos.</p>

<p><strong>Setting up Unicorn</strong></p>

<p><a href="https://github.com/defunkt/unicorn">Unicorn</a> is a HTTP server available for rails and other ruby frameworks that increase concurrency and the performance of your apps without having to increase the number of dynos (for a better explanation on the fundamentals of concurrency see this <a href="http://merbist.com/2011/02/22/concurrency-in-ruby-explained/">excellent post</a>). It does this by spawning extra processes to deal with incoming requests. It rocks, and showed itself to out perform the other popular ruby HTTP servers by a significant margin.</p>

<p>1) Install the Unicorn gem into your gem file</p>

<pre><code>gem 'unicorn'
</code></pre>

<p>2) replace the current <code>web:</code> line in your procfile with</p>

<pre><code>web: bundle exec unicorn_rails -p $PORT -c ./config/unicorn.rb
</code></pre>

<p>3) create a unicorn.rb file in the config directory with the following contents</p>

<pre><code># If you have a very small app you may be able to
# increase this, but in general 3 workers seems to
# work best

worker_processes 3

# Load your app into the master before forking
# workers for super-fast worker spawn times

preload_app true

# Immediately restart any workers that
# haven't responded within 30 seconds

timeout 30

before_fork do |server, worker|

  # Replace with MongoDB or whatever

  if defined?(ActiveRecord::Base)
    ActiveRecord::Base.connection.disconnect!
    Rails.logger.info('Disconnected from ActiveRecord')
  end

  # If you are using Redis but not Resque, change this

  if defined?(Resque)
    Resque.redis.quit
    Rails.logger.info('Disconnected from Redis')
  end

  sleep 1
end

after_fork do |server, worker|

  # Replace with MongoDB or whatever

  if defined?(ActiveRecord::Base)
    ActiveRecord::Base.establish_connection
    Rails.logger.info('Connected to ActiveRecord')
  end

  # If you are using Redis but not Resque, change this

  if defined?(Resque)
    Resque.redis = ENV['REDIS_URI']
    Rails.logger.info('Connected to Redis')
  end
end
</code></pre>

<p>4) finally set up logging so it use STDOUT in the application class of config/application.rb</p>

<pre><code>config.logger = Logger.new(STDOUT)
</code></pre>

<p>The additions of the config file and logger changes fix a few issues that can happen when workers are being spawned/terminated, when adding certain gems like new relic or redis and making sure we get logging information reported correctly.</p>

<p>Thats all there is to setting up unicorn on heroku. On the next deployment to heroku it should start the application running on unicorn with however many workers you specified. To check its working you can see it launch the unicorn server and spawn workers by doing <code>heroku logs --tail</code> whilst deploying.</p>

<p>Iv found that 3 workers works best as any higher you risk breaching heroku&rsquo;s 512mb memory limit per dyno, but you can experiment depending on your application size.</p>

<p><strong>Setting up s3 assets</strong></p>

<p>The easiest way to serve your assets from the cloud is to use the [asset sync gem] (<a href="https://github.com/rumblelabs/asset_sync">https://github.com/rumblelabs/asset_sync</a>). It simplifies dumping your assets to the cloud, when you run <code>rake assets:precompile</code> (done by default when pushing to heroku) your compiled assets will automatically sent over to the cloud, whether thats Amazon S3, Google Storage or Rackspace. The good news is its also very easy to set up. For this setup I am using S3 and assume you have already set up a bucket and added the correct group policy</p>

<p>1) Add the asset sync gem to your gem file</p>

<pre><code>group :assets do

.....
  gem 'asset_sync'
.....

end
</code></pre>

<p>2) in <code>production.rb</code> add our asset host</p>

<pre><code>config.action_controller.asset_host = "//#{ENV['FOG_DIRECTORY']}.s3.amazonaws.com"
</code></pre>

<p>We chose this url over the other style <code>//s3.amazonaws.com/#{ENV['FOG_DIRECTORY']}</code> as we can then have our bucket in any region &ndash; using the second style results in a 301 moved permanently due to reasons explained <a href="https://forums.aws.amazon.com/thread.jspa?threadID=17989">here</a>. There is one caveat however and that is that the bucket name cannot contain any periods (.&rsquo;s) as this will break the ssl certificates over https.</p>

<p>3) make sure the following are set in <code>production.rb</code></p>

<pre><code>config.assets.digest is set to true.
config.assets.enabled is set to true.
</code></pre>

<p>4) One thing that we do is serve out staging assets and production assets from the same bucket. To do this we can add a asset prefix to our environments config file that declares the place the files should be stored within the bucket.</p>

<pre><code>config.assets.prefix = "/production/assets"
</code></pre>

<p>5) add in the following environment variables on heroku</p>

<pre><code>heroku config:add AWS_ACCESS_KEY_ID=xxxx
heroku config:add AWS_SECRET_ACCESS_KEY=xxxx
heroku config:add FOG_DIRECTORY=xxxx  # ( this is the bucket name )
heroku config:add FOG_PROVIDER=AWS

# and optionally:

heroku config:add FOG_REGION=eu-west-1
heroku config:add ASSET_SYNC_GZIP_COMPRESSION=true
heroku config:add ASSET_SYNC_MANIFEST=true
heroku config:add ASSET_SYNC_EXISTING_REMOTE_FILES=keep
</code></pre>

<p>6) finally we need to make sure these variables are available to heroku at asset compilation time so run this from the console in your app root directory</p>

<pre><code>heroku labs:enable user-env-compile -a myapp
</code></pre>

<p><strong>Setting up CloudFront to serve our files even faster</strong></p>

<p>Using a CDN to serve our assets instead of S3 or even the app itself will help improve load times and decrease requests to our app as assets get delivered from a data centre closer to the end users location. Setting up a CloudFront distribution for use with our rails app requires no special configuration options so selecting our bucket and using all the default options will be fine. If you&rsquo;ve used a CDN before you may have had problems expiring files once you&rsquo;ve made changes to them. Thanks to the asset pipeline that comes with rails we don&rsquo;t need to worry about this due to the unique identifier hash that gets appended onto the end of the file name before its extension.</p>

<p>So after our distribution has completed downloading the assets from the bucket we will be given a CloudFront url. All we need to do once we have this url is change our asset host to point to this url</p>

<pre><code>config.action_controller.asset_host = "d1aa907b1q1s7qd.cloudfront.net"
</code></pre>

<p>Now when you make any changes to files and push them to heroku these new files with there unique hashes will get pushed to over to S3 and be different than the previous version. When the first user requests this new file from the CDN it wont be present so amazon is clever enough to attempt to fetch it from the bucket and save it to the CDN ready for the next person</p>

<p><strong>Setting up paperclip to use CloudFront</strong></p>

<p><a href="https://github.com/thoughtbot/paperclip">Paperclip</a> is great for dealing with file attachments and automatically saving things onto S3, but we could optimise this to use CloudFront instead. Its very easy to implement. Once your bucket is set up and files are being saved by paperclip to it, all thats needed is to change the following settings</p>

<p>1) Add in an :s3_host_alias</p>

<pre><code>:s3_host_alias =&gt; 'd1aa907b1q1s7qd.cloudfront.net',
</code></pre>

<p>2) Change :url property to use &ldquo;:s3_alias_url&rdquo;</p>

<pre><code>:url =&gt; ":s3_alias_url"
</code></pre>

<p>notice the symbol is wrapped in a string</p>

<p>And thats it, your uploaded content will now be served over CloudFront and not directly from s3</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - Jordan Rogers-Smith -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'jordanrs-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






		</div>
	</div>
</body>
</html>
